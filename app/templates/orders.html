{% extends "base.html" %}
{% block title %}è¨‚å–®{% endblock %}
{% block content %}

<!-- æœå°‹æ¢ï¼ˆæ©«å‘ï¼‰ -->
<form class="card toolbar" method="get" action="/orders">
  <label class="label">æœå°‹</label>
  <input class="input" type="text" name="q" value="{{ q }}" placeholder="æœå°‹å–®è™Ÿæˆ–é‡‘é¡ï¼ˆæ¸…ç©º=å…¨éƒ¨ï¼‰">
  <label class="label">èµ·</label>
  <input class="input" type="date" name="from_" value="{{ from_ }}">
  <label class="label">è¿„</label>
  <input class="input" type="date" name="to" value="{{ to }}">
  <button class="btn pill primary" type="submit">ğŸ” æœå°‹</button>
</form>

<!-- æ–°å¢ï¼ˆæ©«åˆ—ï¼‰ -->
<form class="card toolbar order-create" method="post" action="/orders/create" id="form-create">
  <div class="row"><label>æ—¥æœŸ</label><input type="date" name="odt" value="{{ today }}"></div>
  <div class="row"><label>ç­åˆ¥</label>
    <select name="shift" class="shift-select"><option>æ—©ç­</option><option>æ™šç­</option></select>
  </div>
  <div class="row"><label>å–®è™Ÿ</label><input id="order_no_input" type="text" name="order_no" placeholder="å¦‚ 10037 æˆ– 37" required></div>
  <div class="row"><label>é‡‘é¡</label><input type="number" name="amount" step="1" placeholder="å¦‚ 2568" required></div>
  <button class="btn primary" type="submit">æ–°å¢</button>
</form>

<!-- åˆªé™¤é¸ä¸­ -->
<form method="post" action="/orders/delete" id="form-delete">
  <table class="table table--orders" id="orders-table">
    <thead>
      <tr>
        <th class="center sortable" data-key="shift">
          <span class="th-label">ç­åˆ¥</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="order_no">
          <span class="th-label">å–®è™Ÿ</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="amount">
          <span class="th-label">é‡‘é¡</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="odt">
          <span class="th-label">æ—¥æœŸ</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center">é¸å–</th>
      </tr>
    </thead>
    <tbody id="orders-body">
      {% for o in orders %}
      <tr data-id="{{ o.id }}" data-idx="{{ o.idx }}">
        <td class="center editable" data-field="shift">{{ o.shift }}</td>
        <td class="center editable" data-field="order_no">{{ o.order_no }}</td>
        <td class="center editable" data-field="amount">{{ o.amount|money }}</td>
        <td class="center editable" data-field="odt">{{ o.odt }}</td>
        <td class="center"><input type="checkbox" name="selected" value="{{ o.id }}"></td>
      </tr>
      {% endfor %}
      {% if not orders %}<tr><td colspan="5" class="center muted">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>{% endif %}
    </tbody>
  </table>

  <div class="actionbar left">
    <button class="btn pill danger" type="submit">åˆªé™¤é¸ä¸­</button>
  </div>
</form>

{% endblock %}
<!-- ===== åªè™•ç†ï¼šæ–°å¢åˆ—å®šä½åˆ°è©²ç­åˆ¥å°¾ç«¯ï¼ˆä¸æ”¹ç¾æœ‰é †åºèˆ‡åŠŸèƒ½ï¼‰ï¼‹ ç­åˆ¥æ ¼æ¼¸å±¤è‰² ===== -->
<script>
(function () {
  const table = document.getElementById('orders-table');
  if (!table) return;

  const $tbody = () => document.getElementById('orders-body');
  const text = el => (el && el.textContent || '').trim();

  // è®€ä¸€åˆ—çš„ç­åˆ¥ï¼šå„ªå…ˆ selectï¼Œå…¶æ¬¡å„²å­˜æ ¼æ–‡å­—ï¼›å®¹éŒ¯ã€Œæ—©/æ™šã€é–‹é ­
  function getShift(tr) {
    const td = tr.querySelector('td[data-field="shift"]');
    if (!td) return '';
    const v = (td.querySelector('select')?.value || text(td)).trim();
    if (!v) return '';
    if (v.startsWith('æ—©')) return 'æ—©ç­';
    if (v.startsWith('æ™š')) return 'æ™šç­';
    return v;
  }

  // æ‰¾æŸç­åˆ¥ã€Œæœ€å¾Œä¸€åˆ—ã€èˆ‡ã€Œç¬¬ä¸€åˆ—ã€
  function findLastOf(shift) {
    const rows = Array.from($tbody().rows);
    for (let i = rows.length - 1; i >= 0; i--) {
      if (getShift(rows[i]) === shift) return rows[i];
    }
    return null;
  }
  function findFirstOf(shift) {
    const rows = Array.from($tbody().rows);
    for (let i = 0; i < rows.length; i++) {
      if (getShift(rows[i]) === shift) return rows[i];
    }
    return null;
  }

  // åƒ…æŠŠã€ŒæŒ‡å®š trã€ç§»åˆ°ã€ŒæŒ‡å®šç­åˆ¥æ®µè½çš„å°¾ç«¯ã€ï¼›ä¸ç¢°å…¶å®ƒåˆ—
  function moveToShiftTailStrict(tr, shift) {
    if (shift === 'æ—©ç­') {
      const lastEarly = findLastOf('æ—©ç­');
      if (lastEarly) {
        if (tr !== lastEarly && tr !== lastEarly.nextSibling) lastEarly.after(tr);
        return;
      }
      // æ²’æœ‰ä»»ä½•æ—©ç­ï¼šæ’åˆ°ç¬¬ä¸€å€‹æ™šç­å‰ï¼›è‹¥ä¹Ÿæ²’æœ‰æ™šç­ï¼Œå°± append
      const firstLate = findFirstOf('æ™šç­');
      if (firstLate) $tbody().insertBefore(tr, firstLate);
      else $tbody().appendChild(tr);
      return;
    }
    if (shift === 'æ™šç­') {
      const lastLate = findLastOf('æ™šç­');
      if (lastLate) {
        if (tr !== lastLate && tr !== lastLate.nextSibling) lastLate.after(tr);
        return;
      }
      // æ²’æœ‰ä»»ä½•æ™šç­ï¼šç›´æ¥ appendï¼ˆç¶­æŒæ—©ç­åœ¨å‰ã€æ™šç­åœ¨å¾Œçš„è¦–è¦ºç¿’æ…£ï¼‰
      $tbody().appendChild(tr);
    }
  }

  // â€”â€” ç­åˆ¥æ ¼è‘—è‰²ï¼ˆä¸å½±éŸ¿é †åºï¼‰
  function paintShiftCell(tr) {
    const td = tr.querySelector('td[data-field="shift"]');
    if (!td) return;
    const s = getShift(tr);
    td.classList.toggle('xshift-early', s === 'æ—©ç­');
    td.classList.toggle('xshift-late',  s === 'æ™šç­');
  }

  // åˆå§‹åªä¸Šè‰²ï¼›**ä¸**èª¿æ•´ä»»ä½•ç¾æœ‰é †åº
  Array.from($tbody().rows).forEach(paintShiftCell);

  // æ–°å¢åˆ—ï¼šæœ‰æ™‚æ¡†æ¶å…ˆæ’å…¥ <tr> å†å¡«æ–‡å­— â†’ ç­‰åˆ°æ‹¿åˆ°ç­åˆ¥å†å®šä½ï¼›åªç§»å‹•æ–°åˆ—æœ¬èº«
  function placeWhenReady(tr) {
    let tries = 0;
    const tryPlace = () => {
      const s = getShift(tr);
      if (s === 'æ—©ç­' || s === 'æ™šç­') {
        moveToShiftTailStrict(tr, s);
        paintShiftCell(tr);
        return true;
      }
      return false;
    };
    if (tryPlace()) return;
    const timer = setInterval(() => {
      tries++;
      if (tryPlace() || tries >= 20) clearInterval(timer); // æœ€å¤š ~1 ç§’ï¼ˆ20*50msï¼‰
    }, 50);
  }

  // ç›£çœ‹ tbodyï¼šåªè™•ç†ã€Œæ–°å¢çš„ trã€ï¼Œå…¶å®ƒä¸å‹•
  let bodyObs;
  function bindTbodyObserver() {
    const tb = $tbody(); if (!tb) return;
    if (bodyObs) bodyObs.disconnect();
    bodyObs = new MutationObserver(muts => {
      muts.forEach(m => {
        m.addedNodes.forEach(node => {
          if (!(node instanceof HTMLElement)) return;
          if (node.tagName === 'TR') {
            placeWhenReady(node);
          } else {
            node.querySelectorAll && node.querySelectorAll('tr').forEach(placeWhenReady);
          }
        });
      });
    });
    bodyObs.observe(tb, { childList: true, subtree: true });
  }
  bindTbodyObserver();

  // è‹¥ä½ çš„æ¡†æ¶æœƒã€Œæ•´å€‹æ›¿æ› tbodyã€ï¼Œå°±é‡æ–°ç¶è§€å¯Ÿå™¨
  const tableObs = new MutationObserver(bindTbodyObserver);
  tableObs.observe(table, { childList: true, subtree: true });

  // ç·¨è¼¯æ™‚åªã€Œé‡ä¸Šè‰²ã€ï¼Œ**ä¸æ¬å‹•**ï¼ˆä½ è¦æ±‚ã€Œå…¶ä»–éƒ½ä¸è¦å‹•ã€ï¼‰
  table.addEventListener('change', e => {
    const td = e.target.closest && e.target.closest('td[data-field="shift"]');
    if (!td) return;
    const tr = td.closest('tr'); if (!tr) return;
    paintShiftCell(tr);
  });
})();
</script>

<style>
/* â€”â€” ä¿æŒä½ åŸæœ¬æ ¼ç·š â€”â€” */
#orders-table { border-collapse: separate; border-spacing: 0; }
#orders-table th, #orders-table td { border-bottom: 1px solid rgba(0,0,0,.12); }

/* â€”â€” ç­åˆ¥æ ¼ï¼šæ¼¸å±¤è‰²ï¼Œä»»ä½•ç‹€æ…‹éƒ½ä¸åç™½ â€”â€” */
#orders-table td[data-field="shift"]{
  background: transparent !important;     /* å…ˆæŠŠå…¨ç«™åç™½æ¸…æ‰ */
  background-clip: padding-box;
}

/* æ—©ç­æ¼¸å±¤ */
#orders-table td[data-field="shift"].xshift-early{
  color:#5A4300 !important;
  background: linear-gradient(135deg, #FAF3D1 0%, #F9E7A6 100%) !important;
}
/* æ™šç­æ¼¸å±¤ */
#orders-table td[data-field="shift"].xshift-late{
  color:#123A6F !important;
  background: linear-gradient(135deg, #E6F0FF 0%, #DDEBFF 100%) !important;
}

/* ç·¨è¼¯/èšç„¦/hover éƒ½ç¶­æŒæ¼¸å±¤èˆ‡å­—è‰²ï¼ˆä¸åç™½ï¼‰ */
#orders-table td[data-field="shift"]:focus,
#orders-table td[data-field="shift"]:focus-within,
#orders-table tr.editing td[data-field="shift"],
#orders-table tr:hover td[data-field="shift"]{
  background: inherit !important;
  color: inherit !important;
}

/* ç·¨è¼¯æ™‚æ–‡å­—å¯è¦‹ï¼ˆé¿å…ç€è¦½å™¨ text-fill æŠŠå­—åƒæ‰ï¼‰ */
#orders-table td[data-field="shift"] input,
#orders-table td[data-field="shift"] select,
#orders-table td[data-field="shift"] textarea{
  background: transparent !important;
  border-color: transparent;
  color: inherit !important;
  -webkit-text-fill-color: inherit;
  caret-color: currentColor;
  box-shadow: none !important;
}
</style>
<script>
(function () {
  const table = document.getElementById('orders-table');
  if (!table) return;
  const $tbody = () => document.getElementById('orders-body');
  const text = el => (el && el.textContent || '').trim();

  // è®€ç­åˆ¥ï¼ˆå®¹éŒ¯ï¼šselect å„ªå…ˆï¼Œå…¶æ¬¡æ–‡å­—ï¼›ã€Œæ—©/æ™šã€é–‹é ­éƒ½ç®—ï¼‰
  function getShift(tr){
    const td = tr.querySelector('td[data-field="shift"]');
    if(!td) return '';
    const v = (td.querySelector('select')?.value || text(td)).trim();
    if (!v) return '';
    if (v.startsWith('æ—©')) return 'æ—©ç­';
    if (v.startsWith('æ™š')) return 'æ™šç­';
    return v;
  }

  // æ‰¾æŸç­åˆ¥çš„å°¾ç«¯
  function findLastOf(shift){
    const rows = Array.from($tbody().rows);
    for (let i = rows.length - 1; i >= 0; i--) {
      if (getShift(rows[i]) === shift) return rows[i];
    }
    return null;
  }

  // åƒ…æ¬å‹•ã€Œé€™ä¸€åˆ—ã€åˆ°ã€Œè©²ç­åˆ¥å°¾ç«¯ã€
  function moveToShiftTail(tr, shift){
    const last = findLastOf(shift);
    if (last) {
      if (tr !== last && tr !== last.nextSibling) last.after(tr);
    } else {
      // è©²ç­åˆ¥ç›®å‰æ²’åˆ—ï¼šç›´æ¥ appendï¼ˆä¸ç¢°å…¶ä»–åˆ—ï¼‰
      $tbody().appendChild(tr);
    }
  }

  // ç­åˆ¥æ ¼ä¸Šè‰²ï¼ˆæ¼¸å±¤ï¼‰
  function paintShiftCell(tr){
    const td = tr.querySelector('td[data-field="shift"]');
    if(!td) return;
    const s = getShift(tr);
    td.classList.toggle('xshift-early', s==='æ—©ç­');
    td.classList.toggle('xshift-late',  s==='æ™šç­');
  }

  // â‘  è¼‰å…¥æ™‚ï¼šæŠŠã€Œæœ€å¤§ data-idï¼ˆæˆ– data-idxï¼‰ã€é‚£ä¸€åˆ—è¦–ç‚ºã€å‰›æ–°å¢ã€åªæ¬å®ƒ
  (function placeNewestOnLoad(){
    const tb = $tbody(); if(!tb) return;
    const rows = Array.from(tb.rows);
    if (!rows.length) return;

    // å…ˆéƒ½ä¸Šè‰²ï¼ˆä¸æ”¹é †åºï¼‰
    rows.forEach(paintShiftCell);

    // ç”¨ data-id ç‚ºä¸»ï¼Œæ²’æœ‰å°±ç”¨ data-idxï¼›å–æ•¸å­—æœ€å¤§è€…
    function num(v){ const n = +String(v||'').replace(/[^0-9\-\.]/g,''); return isNaN(n)?-Infinity:n; }
    let newest = null, best = -Infinity;

    rows.forEach(tr=>{
      const k = Math.max(num(tr.getAttribute('data-id')), num(tr.getAttribute('data-idx')));
      if (k > best) { best = k; newest = tr; }
    });

    if (newest) {
      const s = getShift(newest);
      if (s === 'æ—©ç­' || s === 'æ™šç­') moveToShiftTail(newest, s);
    }
  })();

  // â‘¡ å‹•æ…‹æ–°å¢ï¼šåªæ¬ã€Œæ–°å¢çš„é‚£ä¸€åˆ—ã€
  function placeWhenReady(tr){
    let tries = 0;
    const tick = () => {
      const s = getShift(tr);
      if (s==='æ—©ç­' || s==='æ™šç­') {
        moveToShiftTail(tr, s);
        paintShiftCell(tr);
        return true;
      }
      return false;
    };
    if (tick()) return;
    const t = setInterval(()=>{
      tries++;
      if (tick() || tries>=20) clearInterval(t); // æœ€å¤šç´„ 1s
    }, 50);
  }

  let bodyObs;
  function bindBodyObserver(){
    const tb = $tbody(); if(!tb) return;
    if (bodyObs) bodyObs.disconnect();
    bodyObs = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes.forEach(node=>{
          if(!(node instanceof HTMLElement)) return;
          if(node.tagName==='TR'){ placeWhenReady(node); }
          else { node.querySelectorAll && node.querySelectorAll('tr').forEach(placeWhenReady); }
        });
      });
    });
    bodyObs.observe(tb, { childList:true, subtree:true });
  }

  // å¦‚æœä½ çš„æ¡†æ¶æœƒæ›¿æ› tbodyï¼Œç›£çœ‹ table ä»¥é‡ç¶
  const tableObs = new MutationObserver(bindBodyObserver);
  tableObs.observe(table, { childList:true, subtree:true });
  bindBodyObserver();

  // â‘¢ ç·¨è¼¯ï¼šåªé‡ä¸Šè‰²ï¼Œä¸æ¬å‹•
  table.addEventListener('change', e=>{
    const td = e.target.closest && e.target.closest('td[data-field="shift"]');
    if(!td) return;
    paintShiftCell(td.closest('tr'));
  });
})();
</script>

<style>
/* æ ¼ç·šä¿ç•™ */
#orders-table{ border-collapse: separate; border-spacing: 0; }
#orders-table th, #orders-table td{ border-bottom:1px solid rgba(0,0,0,.12); }

/* ç­åˆ¥æ ¼ï¼šæ¼¸å±¤è‰²å›ºå®šï¼Œä¸åç™½ã€ä¸åƒå­— */
#orders-table td[data-field="shift"]{
  background: transparent !important;
  background-clip: padding-box;
}
#orders-table td[data-field="shift"].xshift-early{
  color:#5A4300 !important;
  background: linear-gradient(135deg, #FAF3D1 0%, #F9E7A6 100%) !important;
}
#orders-table td[data-field="shift"].xshift-late{
  color:#123A6F !important;
  background: linear-gradient(135deg, #E6F0FF 0%, #DDEBFF 100%) !important;
}
#orders-table td[data-field="shift"]:focus,
#orders-table td[data-field="shift"]:focus-within,
#orders-table tr.editing td[data-field="shift"],
#orders-table tr:hover td[data-field="shift"]{
  background: inherit !important;
  color: inherit !important;
}
#orders-table td[data-field="shift"] input,
#orders-table td[data-field="shift"] select,
#orders-table td[data-field="shift"] textarea{
  background: transparent !important;
  border-color: transparent;
  color: inherit !important;
  -webkit-text-fill-color: inherit;
  caret-color: currentColor;
  box-shadow: none !important;
}
</style>
