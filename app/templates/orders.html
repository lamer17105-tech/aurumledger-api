{% extends "base.html" %}
{% block title %}è¨‚å–®{% endblock %}
{% block content %}

<!-- æœå°‹æ¢ï¼ˆæ©«å‘ï¼‰ -->
<form class="card toolbar" method="get" action="/orders">
  <label class="label">æœå°‹</label>
  <input class="input" type="text" name="q" value="{{ q }}" placeholder="æœå°‹å–®è™Ÿæˆ–é‡‘é¡ï¼ˆæ¸…ç©º=å…¨éƒ¨ï¼‰">
  <label class="label">èµ·</label>
  <input class="input" type="date" name="from_" value="{{ from_ }}">
  <label class="label">è¿„</label>
  <input class="input" type="date" name="to" value="{{ to }}">
  <button class="btn pill primary" type="submit">ğŸ” æœå°‹</button>
</form>

<!-- æ–°å¢ï¼ˆæ©«åˆ—ï¼‰ -->
<form class="card toolbar order-create" method="post" action="/orders/create" id="form-create">
  <div class="row"><label>æ—¥æœŸ</label><input type="date" name="odt" value="{{ today }}"></div>
  <div class="row"><label>ç­åˆ¥</label>
    <!-- ä¾é¸æ“‡è‡ªå‹•è‘—è‰²ï¼ˆæ—©=é‡‘é»ƒã€æ™š=æ·¡è—ï¼‰ -->
    <select name="shift" class="shift-select"><option>æ—©ç­</option><option>æ™šç­</option></select>
  </div>
  <div class="row"><label>å–®è™Ÿ</label><input id="order_no_input" type="text" name="order_no" placeholder="å¦‚ 10037 æˆ– 37" required></div>
  <div class="row"><label>é‡‘é¡</label><input type="number" name="amount" step="1" placeholder="å¦‚ 2568" required></div>
  <button class="btn primary" type="submit">æ–°å¢</button>
</form>

<!-- åˆªé™¤é¸ä¸­ -->
<form method="post" action="/orders/delete" id="form-delete">
  <table class="table table--orders" id="orders-table">
    <thead>
      <tr>
        <th class="center sortable" data-key="shift">
          <span class="th-label">ç­åˆ¥</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="order_no">
          <span class="th-label">å–®è™Ÿ</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="amount">
          <span class="th-label">é‡‘é¡</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="odt">
          <span class="th-label">æ—¥æœŸ</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center">é¸å–</th>
      </tr>
    </thead>
    <tbody id="orders-body">
      {% for o in orders %}
      <tr data-id="{{ o.id }}" data-idx="{{ o.idx }}">
        <td class="center editable" data-field="shift">{{ o.shift }}</td>
        <td class="center editable" data-field="order_no">{{ o.order_no }}</td>
        <td class="center editable" data-field="amount">{{ o.amount|money }}</td>
        <td class="center editable" data-field="odt">{{ o.odt }}</td>
        <td class="center"><input type="checkbox" name="selected" value="{{ o.id }}"></td>
      </tr>
      {% endfor %}
      {% if not orders %}<tr><td colspan="5" class="center muted">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>{% endif %}
    </tbody>
  </table>

  <div class="actionbar left">
    <button class="btn pill danger" type="submit">åˆªé™¤é¸ä¸­</button>
  </div>
</form>

<script>
(function(){
  // å›ç„¦åˆ°å–®è™Ÿè¼¸å…¥
  const el = document.getElementById('order_no_input');
  if (el){ el.focus(); el.select(); }

  // === è¨‚å–®æ–°å¢ï¼šç­åˆ¥ select ä¾å€¼è‘—è‰²ï¼ˆæ—©=é‡‘é»ƒã€æ™š=æ·¡è—ï¼‰ ===
  const shiftSel = document.querySelector('.order-create select[name="shift"]');
  function applyShiftSelectColor(){
    if(!shiftSel) return;
    shiftSel.classList.remove('shift-morning','shift-night');
    const v = (shiftSel.value || '').trim();
    shiftSel.classList.add(v === 'æ—©ç­' ? 'shift-morning' : 'shift-night');
  }
  if(shiftSel){
    applyShiftSelectColor();
    shiftSel.addEventListener('change', applyShiftSelectColor);
  }

  // â€”â€” ç­åˆ¥å„²å­˜æ ¼ä¾æ–‡å­—è‘—è‰²ï¼ˆæ—©=é‡‘é»ƒã€æ™š=æ·¡è—ï¼‰ â€”â€” //
  function applyShiftCell(td){
    if(!td) return;
    td.classList.remove('shift-morning','shift-night');
    const txt = td.innerText.trim();
    td.classList.add(txt === 'æ—©ç­' ? 'shift-morning' : 'shift-night');
  }
  function paintAllShiftCells(){
    document.querySelectorAll('#orders-body td[data-field="shift"]').forEach(applyShiftCell);
  }
  paintAllShiftCells();

  // ========= å…§åµŒç·¨è¼¯ =========
  const body = document.getElementById('orders-body');
  let editing = null;

  function makeEditor(td){
    const field = td.dataset.field;
    const tr = td.closest('tr');
    const id = tr.dataset.id;
    const old = td.innerText.trim().replace(/,/g,'');
    let input;

    if(field === 'shift'){
      input = document.createElement('select');
      ['æ—©ç­','æ™šç­'].forEach(s=>{
        const o=document.createElement('option'); o.textContent=s; o.value=s;
        if(s===old) o.selected=true; input.appendChild(o);
      });
    }else if(field === 'odt'){
      input = document.createElement('input'); input.type='date'; input.value = old;
    }else if(field === 'amount'){
      input = document.createElement('input'); input.type='number'; input.step='1'; input.value = old.replaceAll(',','');
    }else{
      input = document.createElement('input'); input.type='text'; input.value = old;
    }
    input.className = 'cell-editor center';
    input.style.textAlign = 'center';

    td.dataset.old = old;
    td.innerHTML=''; td.appendChild(input);
    input.focus();
    if (input.tagName === 'INPUT' && typeof input.select === 'function') input.select();

    const save = ()=>{
      const value = (input.value || '').trim();
      fetch('/orders/update-json', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id, field, value})
      }).then(r=>r.json()).then(j=>{
        td.innerHTML = j.ok ? (field==='amount' ? Number(j.value).toLocaleString() : j.value) : td.dataset.old;
        if (field === 'shift') applyShiftCell(td); // ä¿å­˜å¾Œä¾æ–°å€¼è‘—è‰²
        editing = null;
      }).catch(()=>{ td.innerHTML = td.dataset.old; editing=null; });
    };
    const cancel = ()=>{ td.innerHTML = td.dataset.old; editing=null; };

    if (input.tagName === 'SELECT'){ input.addEventListener('change', ()=> save()); }
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); save(); }
      if(e.key==='Escape'){ e.preventDefault(); cancel(); }
    });
    input.addEventListener('blur', ()=>{ if(editing) save(); });

    editing = {td, input};
  }

  body.addEventListener('click', (e)=>{
    const td = e.target.closest('td.editable');
    if(!td || editing) return;
    makeEditor(td);
  });

  // ========= è¡¨é ­é»æ“Šæ’åºï¼ˆå†æ¬¡é»æ“Šæ¢å¾©åŸæ’åºï¼‰ =========
  const table = document.getElementById('orders-table');
  const tbody = document.getElementById('orders-body');
  const orig = Array.from(tbody.querySelectorAll('tr')).map(tr=>tr);
  let currentKey = null;

  function applySort(key){
    if(currentKey === key){ // ç¬¬äºŒæ¬¡é»æ“Š -> æ¢å¾©åŸæ’åº
      while(tbody.firstChild) tbody.removeChild(tbody.firstChild);
      orig.sort((a,b)=> Number(a.dataset.idx)-Number(b.dataset.idx));
      orig.forEach(tr=>tbody.appendChild(tr));
      currentKey = null;
      return;
    }
    const rows = Array.from(orig);
    rows.sort((a,b)=>{
      const ta = a.querySelector(`[data-field="${key}"]`).innerText.trim().replace(/,/g,'');
      const tb = b.querySelector(`[data-field="${key}"]`).innerText.trim().replace(/,/g,'');
      if(key==='amount'){ return (Number(ta)-Number(tb)); }
      return (ta>tb?1:ta<tb?-1:0);
    });
    while(tbody.firstChild) tbody.removeChild(tbody.firstChild);
    rows.forEach(tr=>tbody.appendChild(tr));
    currentKey = key;
  }
  table.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>applySort(th.dataset.key));
  });

  // ========= æ‹–æ›³å‹¾é¸ + Shift ç¯„åœå‹¾é¸ =========
  let dragSelecting = false;
  let dragState = true;
  let lastClickIndex = null;

  // æŒ‰ä½ã€Œé¸å–ã€æ¬„ä»»ä¸€åˆ—é–‹å§‹æ‹–æ›³
  tbody.addEventListener('mousedown', (e)=>{
    const cell = e.target.closest('td');
    if(!cell) return;
    const cb = cell.querySelector('input[type="checkbox"]');
    if(!cb) return;
    dragSelecting = true;
    dragState = !cb.checked;   // åè½‰å¾Œå¥—ç”¨åˆ°æ‹–æ›³ç¶“éçš„åˆ—
    cb.checked = dragState;
    e.preventDefault();        // é¿å…æ–‡å­—è¢«é¸å–
  });

  // æ‹–æ›³ç¶“éå³åŒæ­¥å¥—ç”¨
  tbody.addEventListener('mouseover', (e)=>{
    if(!dragSelecting) return;
    const tr = e.target.closest('tr'); if(!tr) return;
    const cb = tr.querySelector('input[type="checkbox"]'); if(cb) cb.checked = dragState;
  });

  // æ”¾é–‹æ»‘é¼ çµæŸæ‹–æ›³
  document.addEventListener('mouseup', ()=>{ dragSelecting = false; });

  // Shift + click ç¯„åœé¸å–
  tbody.addEventListener('click', (e)=>{
    const cb = e.target.closest('input[type="checkbox"]');
    if(!cb) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const idx  = rows.indexOf(cb.closest('tr'));
    if(e.shiftKey && lastClickIndex != null){
      const [s,eidx] = idx > lastClickIndex ? [lastClickIndex, idx] : [idx, lastClickIndex];
      for(let i=s;i<=eidx;i++){
        const cbi = rows[i].querySelector('input[type="checkbox"]');
        if(cbi) cbi.checked = cb.checked;
      }
    }
    lastClickIndex = idx;
  });
})();
</script>
{% endblock %}
