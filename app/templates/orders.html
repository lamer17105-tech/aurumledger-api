{% extends "base.html" %}
{% block title %}訂單{% endblock %}
{% block content %}

<!-- 搜尋條（橫向） -->
<form class="card toolbar" method="get" action="/orders">
  <label class="label">搜尋</label>
  <input class="input" type="text" name="q" value="{{ q }}" placeholder="搜尋單號或金額（清空=全部）">
  <label class="label">起</label>
  <input class="input" type="date" name="from_" value="{{ from_ }}">
  <label class="label">迄</label>
  <input class="input" type="date" name="to" value="{{ to }}">
  <button class="btn pill primary" type="submit">🔎 搜尋</button>
</form>

<!-- 新增（橫列） -->
<form class="card toolbar order-create" method="post" action="/orders/create" id="form-create">
  <div class="row"><label>日期</label><input type="date" name="odt" value="{{ today }}"></div>
  <div class="row"><label>班別</label>
    <!-- 依選擇自動著色（早=金黃、晚=淡藍） -->
    <select name="shift" class="shift-select"><option>早班</option><option>晚班</option></select>
  </div>
  <div class="row"><label>單號</label><input id="order_no_input" type="text" name="order_no" placeholder="如 10037 或 37" required></div>
  <div class="row"><label>金額</label><input type="number" name="amount" step="1" placeholder="如 2568" required></div>
  <button class="btn primary" type="submit">新增</button>
</form>

<!-- 刪除選中 -->
<form method="post" action="/orders/delete" id="form-delete">
  <table class="table table--orders" id="orders-table">
    <thead>
      <tr>
        <th class="center sortable" data-key="shift">
          <span class="th-label">班別</span>
          <span class="th-badge" title="可點擊排序／再點一次恢復" aria-label="可點擊排序">⇅</span>
        </th>
        <th class="center sortable" data-key="order_no">
          <span class="th-label">單號</span>
          <span class="th-badge" title="可點擊排序／再點一次恢復" aria-label="可點擊排序">⇅</span>
        </th>
        <th class="center sortable" data-key="amount">
          <span class="th-label">金額</span>
          <span class="th-badge" title="可點擊排序／再點一次恢復" aria-label="可點擊排序">⇅</span>
        </th>
        <th class="center sortable" data-key="odt">
          <span class="th-label">日期</span>
          <span class="th-badge" title="可點擊排序／再點一次恢復" aria-label="可點擊排序">⇅</span>
        </th>
        <th class="center">選取</th>
      </tr>
    </thead>
    <tbody id="orders-body">
      {% for o in orders %}
      <tr data-id="{{ o.id }}" data-idx="{{ o.idx }}">
        <td class="center editable" data-field="shift">{{ o.shift }}</td>
        <td class="center editable" data-field="order_no">{{ o.order_no }}</td>
        <td class="center editable" data-field="amount">{{ o.amount|money }}</td>
        <td class="center editable" data-field="odt">{{ o.odt }}</td>
        <td class="center"><input type="checkbox" name="selected" value="{{ o.id }}"></td>
      </tr>
      {% endfor %}
      {% if not orders %}<tr><td colspan="5" class="center muted">目前沒有資料</td></tr>{% endif %}
    </tbody>
  </table>

  <div class="actionbar left">
    <button class="btn pill danger" type="submit">刪除選中</button>
  </div>
</form>

<script>
(function(){
  // 回焦到單號輸入
  const el = document.getElementById('order_no_input');
  if (el){ el.focus(); el.select(); }

  // === 訂單新增：班別 select 依值著色（早=金黃、晚=淡藍） ===
  const shiftSel = document.querySelector('.order-create select[name="shift"]');
  function applyShiftSelectColor(){
    if(!shiftSel) return;
    shiftSel.classList.remove('shift-morning','shift-night');
    const v = (shiftSel.value || '').trim();
    shiftSel.classList.add(v === '早班' ? 'shift-morning' : 'shift-night');
  }
  if(shiftSel){
    applyShiftSelectColor();
    shiftSel.addEventListener('change', applyShiftSelectColor);
  }

  // —— 班別儲存格依文字著色（早=金黃、晚=淡藍） —— //
  function applyShiftCell(td){
    if(!td) return;
    td.classList.remove('shift-morning','shift-night');
    const txt = td.innerText.trim();
    td.classList.add(txt === '早班' ? 'shift-morning' : 'shift-night');
  }
  function paintAllShiftCells(){
    document.querySelectorAll('#orders-body td[data-field="shift"]').forEach(applyShiftCell);
  }
  paintAllShiftCells();

  // ========= 內嵌編輯 =========
  const body = document.getElementById('orders-body');
  let editing = null;

  function makeEditor(td){
    const field = td.dataset.field;
    const tr = td.closest('tr');
    const id = tr.dataset.id;
    const old = td.innerText.trim().replace(/,/g,'');
    let input;

    if(field === 'shift'){
      input = document.createElement('select');
      ['早班','晚班'].forEach(s=>{
        const o=document.createElement('option'); o.textContent=s; o.value=s;
        if(s===old) o.selected=true; input.appendChild(o);
      });
    }else if(field === 'odt'){
      input = document.createElement('input'); input.type='date'; input.value = old;
    }else if(field === 'amount'){
      input = document.createElement('input'); input.type='number'; input.step='1'; input.value = old.replaceAll(',','');
    }else{
      input = document.createElement('input'); input.type='text'; input.value = old;
    }
    input.className = 'cell-editor center';
    input.style.textAlign = 'center';

    td.dataset.old = old;
    td.innerHTML=''; td.appendChild(input);
    input.focus();
    if (input.tagName === 'INPUT' && typeof input.select === 'function') input.select();

    const save = ()=>{
      const value = (input.value || '').trim();
      fetch('/orders/update-json', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id, field, value})
      }).then(r=>r.json()).then(j=>{
        td.innerHTML = j.ok ? (field==='amount' ? Number(j.value).toLocaleString() : j.value) : td.dataset.old;
        if (field === 'shift') applyShiftCell(td); // 保存後依新值著色
        editing = null;
      }).catch(()=>{ td.innerHTML = td.dataset.old; editing=null; });
    };
    const cancel = ()=>{ td.innerHTML = td.dataset.old; editing=null; };

    if (input.tagName === 'SELECT'){ input.addEventListener('change', ()=> save()); }
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); save(); }
      if(e.key==='Escape'){ e.preventDefault(); cancel(); }
    });
    input.addEventListener('blur', ()=>{ if(editing) save(); });

    editing = {td, input};
  }

  body.addEventListener('click', (e)=>{
    const td = e.target.closest('td.editable');
    if(!td || editing) return;
    makeEditor(td);
  });

  // ========= 表頭點擊排序（再次點擊恢復原排序） =========
  const table = document.getElementById('orders-table');
  const tbody = document.getElementById('orders-body');
  const orig = Array.from(tbody.querySelectorAll('tr')).map(tr=>tr);
  let currentKey = null;

  function applySort(key){
    if(currentKey === key){ // 第二次點擊 -> 恢復原排序
      while(tbody.firstChild) tbody.removeChild(tbody.firstChild);
      orig.sort((a,b)=> Number(a.dataset.idx)-Number(b.dataset.idx));
      orig.forEach(tr=>tbody.appendChild(tr));
      currentKey = null;
      return;
    }
    const rows = Array.from(orig);
    rows.sort((a,b)=>{
      const ta = a.querySelector(`[data-field="${key}"]`).innerText.trim().replace(/,/g,'');
      const tb = b.querySelector(`[data-field="${key}"]`).innerText.trim().replace(/,/g,'');
      if(key==='amount'){ return (Number(ta)-Number(tb)); }
      return (ta>tb?1:ta<tb?-1:0);
    });
    while(tbody.firstChild) tbody.removeChild(tbody.firstChild);
    rows.forEach(tr=>tbody.appendChild(tr));
    currentKey = key;
  }
  table.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>applySort(th.dataset.key));
  });

  // ========= 拖曳勾選 + Shift 範圍勾選 =========
  let dragSelecting = false;
  let dragState = true;
  let lastClickIndex = null;

  // 按住「選取」欄任一列開始拖曳
  tbody.addEventListener('mousedown', (e)=>{
    const cell = e.target.closest('td');
    if(!cell) return;
    const cb = cell.querySelector('input[type="checkbox"]');
    if(!cb) return;
    dragSelecting = true;
    dragState = !cb.checked;   // 反轉後套用到拖曳經過的列
    cb.checked = dragState;
    e.preventDefault();        // 避免文字被選取
  });

  // 拖曳經過即同步套用
  tbody.addEventListener('mouseover', (e)=>{
    if(!dragSelecting) return;
    const tr = e.target.closest('tr'); if(!tr) return;
    const cb = tr.querySelector('input[type="checkbox"]'); if(cb) cb.checked = dragState;
  });

  // 放開滑鼠結束拖曳
  document.addEventListener('mouseup', ()=>{ dragSelecting = false; });

  // Shift + click 範圍選取
  tbody.addEventListener('click', (e)=>{
    const cb = e.target.closest('input[type="checkbox"]');
    if(!cb) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const idx  = rows.indexOf(cb.closest('tr'));
    if(e.shiftKey && lastClickIndex != null){
      const [s,eidx] = idx > lastClickIndex ? [lastClickIndex, idx] : [idx, lastClickIndex];
      for(let i=s;i<=eidx;i++){
        const cbi = rows[i].querySelector('input[type="checkbox"]');
        if(cbi) cbi.checked = cb.checked;
      }
    }
    lastClickIndex = idx;
  });
})();
</script>
{% endblock %}
