<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>{% block title %}AurumLedger{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}?v=gold1">
</head>
<body>
  <div class="app {% if auth_only %}auth-only{% endif %}">
    {% if not auth_only %}
    <aside class="sidebar">
      <div class="brand">
        <a href="{{ url_for('orders_page') }}" class="brand-link" style="text-decoration:none;color:inherit;display:inline-block">
          <div class="brand-title nowrap">ğŸ“Š AurumLedger ä¼æ¥­ç‰ˆ</div>
          <div class="brand-sub nowrap">é¤é£²ä½œå¸³ç³»çµ±</div>
        </a>
      </div>
      <nav class="nav">
        {% set path = request.url.path %}
        <a class="nav-item {% if '/orders' in path %}active{% endif %}"  href="{{ url_for('orders_page') }}">ğŸ“„ è¨‚å–®</a>
        <a class="nav-item {% if '/expenses' in path %}active{% endif %}" href="{{ url_for('expenses_page') }}">ğŸ’¸ æ”¯å‡º</a>
        <a class="nav-item {% if '/kpi' in path %}active{% endif %}"      href="{{ url_for('kpi_page') }}">ğŸ“ˆ ç‡Ÿæ¥­é¡</a>
        <a class="nav-item {% if '/reports' in path %}active{% endif %}"  href="{{ url_for('reports_page') }}">ğŸ“Š å ±è¡¨</a>
        <a class="nav-item {% if '/ai' in path %}active{% endif %}"       href="{{ url_for('ai_page') }}">ğŸ¤– AI æ™ºèƒ½åŠ©æ‰‹</a>
        <a class="nav-item {% if '/backup' in path %}active{% endif %}"   href="{{ url_for('backup_page') }}">ğŸ§° å‚™ä»½</a>
      </nav>
    </aside>
    {% endif %}

    <main class="main">
      <section class="content {% if auth_only %}auth-center{% else %}tight{% endif %}">
        {% block content %}{% endblock %}
      </section>
    </main>

    {% if not auth_only %}
    <div class="corner-actions">
      {% if user %}
        <a class="btn pill" href="{{ url_for('account_page') }}">å¸³è™Ÿè¨­å®š</a>
        <a class="btn pill danger" href="{{ url_for('logout') }}">ç™»å‡º</a>
      {% else %}
        <a class="btn pill primary" href="{{ url_for('login_page') }}">ç™»å…¥</a>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- ================== è¼•é‡ã€ä¸è¡çªçš„å…¨ç«™è¡Œç‚º ================== -->
  <script>
  (function () {
    "use strict";
    const PATH = location.pathname;
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    /* A) æ–°å¢è¡¨å–®ï¼šç­åˆ¥è¨˜æ†¶ + è‘—è‰²ï¼ˆä¸å½±éŸ¿å…§åµŒç·¨è¼¯èˆ‡æ‹–æ›³ï¼‰ */
    function paintShiftSelect(sel){
      if (!sel) return;
      sel.classList.add('shift-select');
      sel.classList.remove('is-morning','is-night');
      const v = (sel.value || sel.options?.[sel.selectedIndex]?.text || '').trim();
      if (/æ—©/.test(v)) sel.classList.add('is-morning'); else if (/æ™š/.test(v)) sel.classList.add('is-night');
    }
    function rememberShift(){
      const box = document.querySelector('.order-create');
      if (!box) return;
      const sel = box.querySelector('select[name="shift"], .shift-select, [data-role="shift"]');
      if (!sel) return;
      const KEY = 'orders_new_shift';
      const saved = sessionStorage.getItem(KEY);
      if (saved){
        for (const o of sel.options || []) {
          if (o.value === saved || (o.text||'').includes(saved)) { sel.value = o.value; break; }
        }
      }
      paintShiftSelect(sel);
      sel.addEventListener('change', ()=>{
        paintShiftSelect(sel);
        const v = sel.value || sel.options?.[sel.selectedIndex]?.text || '';
        sessionStorage.setItem(KEY, v);
      });
    }

    /* B) è¨‚å–®ï¼šå¿«é€Ÿæœå°‹ï¼ˆæ¸…ç©ºâ†’å›å…¨éƒ¨ï¼›æœå°‹å®Œè‡ªå‹•å›ç„¦ï¼‰ */
    function ordersQuickSearch(){
      if (!/\/orders(\/|$)/.test(PATH)) return;  // æ”¯æ´å­è·¯å¾‘
      const toolbar = document.querySelector('.toolbar, .search-bar, .filter-bar');
      if (!toolbar) return;
      const q = toolbar.querySelector('input[name="q"]') || toolbar.querySelector('input[type="text"],input[type="search"]');
      if (!q) return;

      let prev = q.value || '';
      q.addEventListener('input', ()=>{
        const v = q.value || '';
        if (prev && !v && location.search) {
          sessionStorage.setItem('orders_focus_search','1');
          location.href = '{{ url_for("orders_page") }}#search';
        }
        prev = v;
      });

      const form = q.form || toolbar.closest('form');
      if (form){
        form.addEventListener('submit', ()=>{
          sessionStorage.setItem('orders_focus_search','1');
          try{
            const u = new URL(form.action || location.href, location.origin);
            form.action = u.pathname + u.search + '#search';
          }catch{}
        }, {capture:true});
      }

      function maybeFocus(){
        if (sessionStorage.getItem('orders_focus_search')==='1' || location.hash==='#search' || location.search){
          requestAnimationFrame(()=>{
            (q || toolbar.querySelector('input,select'))?.focus();
            q?.select?.();
            toolbar.scrollIntoView({block:'start'});
          });
          sessionStorage.removeItem('orders_focus_search');
        }
      }
      document.addEventListener('DOMContentLoaded', maybeFocus);
      window.addEventListener('pageshow', maybeFocus);
    }

    /* C) KPI/æ”¯å‡º ç¯„åœé¸æ“‡ï¼šè‡ªå‹•é€å‡ºï¼ˆè®“ KPI çœŸçš„ã€ŒåŒæ­¥æ›´æ–°ã€ï¼‰ */
    function autoSubmitRangeForm(){
      const form = document.getElementById('range-form');
      if (!form) return;
      const mode = form.querySelector('#mode') || form.querySelector('select[name="mode"]');
      const dt   = form.querySelector('#dt')   || form.querySelector('input[name="dt"]');
      if (mode) mode.addEventListener('change', ()=>form.submit());
      if (dt)   dt.addEventListener('change',   ()=>form.submit());
    }

    /* D) æ–°å¢é€å‡ºå¾Œå›ç„¦ã€Œå–®è™Ÿã€ï¼šé…åˆ /orders.html çš„ #order_no_input */
    function focusOrderNoAfterCreate(){
      if (!/\/orders(\/|$)/.test(PATH)) return;  // æ”¯æ´å­è·¯å¾‘
      const input = document.getElementById('order_no_input')
                 || document.querySelector('input[name="order_no"]');
      if (!input) return;
      if (location.hash==='#create' || sessionStorage.getItem('orders_focus_orderno')==='1'){
        requestAnimationFrame(()=>{ input.focus(); input.select?.(); });
        sessionStorage.removeItem('orders_focus_orderno');
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      rememberShift();
      ordersQuickSearch();
      autoSubmitRangeForm();
      focusOrderNoAfterCreate();
    });
  })();
  </script>

  <!-- å…¨ç«™ä¸»åŠ› JSï¼ˆå«æ‹–æ›³å‹¾é¸ã€å…§åµŒç·¨è¼¯ã€å ±è¡¨åŒ¯å‡ºã€è¡¨å–®è‡ªå‹•é€å‡ºç­‰ï¼‰ -->
  <script src="{{ url_for('static', path='/js/app.js') }}?v=dragfix1"></script>

  <!-- === KPI é‡‘é¡è‡ªå‹•ç¸®æ”¾ï¼ˆåªèª¿å­—ç´šï¼›ä¸æ”¹å¡ç‰‡çµæ§‹/å°ºå¯¸ï¼‰ === -->
  <script>
  (function(){
    if (!/\/kpi(\/|$)/.test(location.pathname)) return;  // æ”¯æ´å­è·¯å¾‘

    const MIN_FONT = 26;   // æœ€å°å­—ç´š
    const PAD = 6;         // é‚Šç·£ç·©è¡

    function fitOne(el){
      const cs = getComputedStyle(el);
      let size = parseFloat(cs.fontSize) || 56;
      el.style.fontSize = size + 'px';
      let guard = 0;
      while ((el.scrollWidth > el.clientWidth - PAD || el.scrollHeight > el.clientHeight - PAD)
             && size > MIN_FONT && guard < 120) {
        size -= 1;
        el.style.fontSize = size + 'px';
        guard++;
      }
    }
    function fitAll(){
      document.querySelectorAll('.kpi-card .kpi-value').forEach(fitOne);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fitAll, {once:true});
    } else {
      fitAll();
    }
    window.addEventListener('resize', fitAll);
    new MutationObserver(fitAll).observe(document.body, {subtree:true, childList:true, characterData:true});
    if (document.fonts && document.fonts.ready) { document.fonts.ready.then(fitAll); }
    setTimeout(fitAll, 200);
    setTimeout(fitAll, 800);
  })();
  </script>
</body>
</html>
