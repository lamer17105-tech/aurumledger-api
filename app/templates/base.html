<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>{% block title %}AurumLedger{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}?v=gold1">
</head>
<body>
  <div class="app {% if auth_only %}auth-only{% endif %}">
    {% if not auth_only %}
    <aside class="sidebar">
      <div class="brand">
        <a href="{{ url_for('orders_page') }}" class="brand-link" style="text-decoration:none;color:inherit;display:inline-block">
          <div class="brand-title nowrap">📊 AurumLedger 企業版</div>
          <div class="brand-sub nowrap">餐飲作帳系統</div>
        </a>
      </div>
      <nav class="nav">
        {% set path = request.url.path %}
        <a class="nav-item {% if '/orders' in path %}active{% endif %}"  href="{{ url_for('orders_page') }}">📄 訂單</a>
        <a class="nav-item {% if '/expenses' in path %}active{% endif %}" href="{{ url_for('expenses_page') }}">💸 支出</a>
        <a class="nav-item {% if '/kpi' in path %}active{% endif %}"      href="{{ url_for('kpi_page') }}">📈 營業額</a>
        <a class="nav-item {% if '/reports' in path %}active{% endif %}"  href="{{ url_for('reports_page') }}">📊 報表</a>
        <a class="nav-item {% if '/ai' in path %}active{% endif %}"       href="{{ url_for('ai_page') }}">🤖 AI 智能助手</a>
        <a class="nav-item {% if '/backup' in path %}active{% endif %}"   href="{{ url_for('backup_page') }}">🧰 備份</a>
      </nav>
    </aside>
    {% endif %}

    <main class="main">
      <section class="content {% if auth_only %}auth-center{% else %}tight{% endif %}">
        {% block content %}{% endblock %}
      </section>
    </main>

    {% if not auth_only %}
    <div class="corner-actions">
      {% if user %}
        <a class="btn pill" href="{{ url_for('account_page') }}">帳號設定</a>
        <a class="btn pill danger" href="{{ url_for('logout') }}">登出</a>
      {% else %}
        <a class="btn pill primary" href="{{ url_for('login_page') }}">登入</a>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- ================== 輕量、不衝突的全站行為 ================== -->
  <script>
  (function () {
    "use strict";
    const PATH = location.pathname;
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    /* A) 新增表單：班別記憶 + 著色（不影響內嵌編輯與拖曳） */
    function paintShiftSelect(sel){
      if (!sel) return;
      sel.classList.add('shift-select');
      sel.classList.remove('is-morning','is-night');
      const v = (sel.value || sel.options?.[sel.selectedIndex]?.text || '').trim();
      if (/早/.test(v)) sel.classList.add('is-morning'); else if (/晚/.test(v)) sel.classList.add('is-night');
    }
    function rememberShift(){
      const box = document.querySelector('.order-create');
      if (!box) return;
      const sel = box.querySelector('select[name="shift"], .shift-select, [data-role="shift"]');
      if (!sel) return;
      const KEY = 'orders_new_shift';
      const saved = sessionStorage.getItem(KEY);
      if (saved){
        for (const o of sel.options || []) {
          if (o.value === saved || (o.text||'').includes(saved)) { sel.value = o.value; break; }
        }
      }
      paintShiftSelect(sel);
      sel.addEventListener('change', ()=>{
        paintShiftSelect(sel);
        const v = sel.value || sel.options?.[sel.selectedIndex]?.text || '';
        sessionStorage.setItem(KEY, v);
      });
    }

    /* B) 訂單：快速搜尋（清空→回全部；搜尋完自動回焦） */
    function ordersQuickSearch(){
      if (!/\/orders(\/|$)/.test(PATH)) return;  // 支援子路徑
      const toolbar = document.querySelector('.toolbar, .search-bar, .filter-bar');
      if (!toolbar) return;
      const q = toolbar.querySelector('input[name="q"]') || toolbar.querySelector('input[type="text"],input[type="search"]');
      if (!q) return;

      let prev = q.value || '';
      q.addEventListener('input', ()=>{
        const v = q.value || '';
        if (prev && !v && location.search) {
          sessionStorage.setItem('orders_focus_search','1');
          location.href = '{{ url_for("orders_page") }}#search';
        }
        prev = v;
      });

      const form = q.form || toolbar.closest('form');
      if (form){
        form.addEventListener('submit', ()=>{
          sessionStorage.setItem('orders_focus_search','1');
          try{
            const u = new URL(form.action || location.href, location.origin);
            form.action = u.pathname + u.search + '#search';
          }catch{}
        }, {capture:true});
      }

      function maybeFocus(){
        if (sessionStorage.getItem('orders_focus_search')==='1' || location.hash==='#search' || location.search){
          requestAnimationFrame(()=>{
            (q || toolbar.querySelector('input,select'))?.focus();
            q?.select?.();
            toolbar.scrollIntoView({block:'start'});
          });
          sessionStorage.removeItem('orders_focus_search');
        }
      }
      document.addEventListener('DOMContentLoaded', maybeFocus);
      window.addEventListener('pageshow', maybeFocus);
    }

    /* C) KPI/支出 範圍選擇：自動送出（讓 KPI 真的「同步更新」） */
    function autoSubmitRangeForm(){
      const form = document.getElementById('range-form');
      if (!form) return;
      const mode = form.querySelector('#mode') || form.querySelector('select[name="mode"]');
      const dt   = form.querySelector('#dt')   || form.querySelector('input[name="dt"]');
      if (mode) mode.addEventListener('change', ()=>form.submit());
      if (dt)   dt.addEventListener('change',   ()=>form.submit());
    }

    /* D) 新增送出後回焦「單號」：配合 /orders.html 的 #order_no_input */
    function focusOrderNoAfterCreate(){
      if (!/\/orders(\/|$)/.test(PATH)) return;  // 支援子路徑
      const input = document.getElementById('order_no_input')
                 || document.querySelector('input[name="order_no"]');
      if (!input) return;
      if (location.hash==='#create' || sessionStorage.getItem('orders_focus_orderno')==='1'){
        requestAnimationFrame(()=>{ input.focus(); input.select?.(); });
        sessionStorage.removeItem('orders_focus_orderno');
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      rememberShift();
      ordersQuickSearch();
      autoSubmitRangeForm();
      focusOrderNoAfterCreate();
    });
  })();
  </script>

  <!-- 全站主力 JS（含拖曳勾選、內嵌編輯、報表匯出、表單自動送出等） -->
  <script src="{{ url_for('static', path='/js/app.js') }}?v=dragfix1"></script>

  <!-- === KPI 金額自動縮放（只調字級；不改卡片結構/尺寸） === -->
  <script>
  (function(){
    if (!/\/kpi(\/|$)/.test(location.pathname)) return;  // 支援子路徑

    const MIN_FONT = 26;   // 最小字級
    const PAD = 6;         // 邊緣緩衝

    function fitOne(el){
      const cs = getComputedStyle(el);
      let size = parseFloat(cs.fontSize) || 56;
      el.style.fontSize = size + 'px';
      let guard = 0;
      while ((el.scrollWidth > el.clientWidth - PAD || el.scrollHeight > el.clientHeight - PAD)
             && size > MIN_FONT && guard < 120) {
        size -= 1;
        el.style.fontSize = size + 'px';
        guard++;
      }
    }
    function fitAll(){
      document.querySelectorAll('.kpi-card .kpi-value').forEach(fitOne);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fitAll, {once:true});
    } else {
      fitAll();
    }
    window.addEventListener('resize', fitAll);
    new MutationObserver(fitAll).observe(document.body, {subtree:true, childList:true, characterData:true});
    if (document.fonts && document.fonts.ready) { document.fonts.ready.then(fitAll); }
    setTimeout(fitAll, 200);
    setTimeout(fitAll, 800);
  })();
  </script>
</body>
</html>
