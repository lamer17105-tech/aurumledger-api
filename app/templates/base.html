<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>{% block title %}AurumLedger{% endblock %}ï½œAurumLedger ä¼æ¥­ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% set rp = request.scope.get('root_path','') %}
  <!-- å–®ä¸€ CSSï¼ˆè·Ÿè‘— root_path èµ°ï¼‰ -->
  <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}?v=20250909c">
</head>
<body data-rootpath="{{ rp }}">
  <div class="app {% if auth_only %}auth-only{% endif %}">
    {% if not auth_only %}
    <aside class="sidebar">
      <div class="brand">
        <a href="{{ rp }}/orders" class="brand-link" style="text-decoration:none;color:inherit;display:inline-block">
          <div class="brand-title nowrap">ğŸ“Š AurumLedger ä¼æ¥­ç‰ˆ</div>
          <div class="brand-sub nowrap">é¤é£²ä½œå¸³ç³»çµ±</div>
        </a>
      </div>
      <nav class="nav">
        {% set path = request.url.path %}
        <a class="nav-item {% if path.startswith(rp ~ '/orders') %}active{% endif %}"  href="{{ rp }}/orders">ğŸ“„ è¨‚å–®</a>
        <a class="nav-item {% if path.startswith(rp ~ '/expenses') %}active{% endif %}" href="{{ rp }}/expenses">ğŸ’¸ æ”¯å‡º</a>
        <a class="nav-item {% if path.startswith(rp ~ '/kpi') %}active{% endif %}"      href="{{ rp }}/kpi">ğŸ“ˆ ç‡Ÿæ¥­é¡</a>
        <a class="nav-item {% if path.startswith(rp ~ '/reports') %}active{% endif %}"  href="{{ rp }}/reports">ğŸ“Š å ±è¡¨</a>
        <a class="nav-item {% if path.startswith(rp ~ '/ai') %}active{% endif %}"       href="{{ rp }}/ai">ğŸ¤– AI æ™ºèƒ½åŠ©æ‰‹</a>
        <a class="nav-item {% if path.startswith(rp ~ '/backup') %}active{% endif %}"   href="{{ rp }}/backup">ğŸ§° å‚™ä»½</a>
      </nav>
    </aside>
    {% endif %}

    <main class="main">
      <section class="content {% if auth_only %}auth-center{% else %}tight{% endif %}">
        {% block content %}{% endblock %}
      </section>
    </main>

    {% if not auth_only %}
    <div class="corner-actions">
      {% if user %}
        <a class="btn pill" href="{{ rp }}/account">å¸³è™Ÿè¨­å®š</a>
        <a class="btn pill danger" href="{{ rp }}/logout">ç™»å‡º</a>
      {% else %}
        <a class="btn pill primary" href="{{ rp }}/login">ç™»å…¥</a>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- æ ¹è·¯å¾‘å°å‘ï¼ˆä¾‹å¦‚ /ui â†’ /ui/ordersï¼‰ -->
  <script>
  (function(){
    const rp = document.body?.dataset?.rootpath || "";
    const p  = location.pathname.replace(/\/+$/,'');
    if (rp && p === rp) location.replace(rp + "/orders");
  })();
  </script>

  <!-- ================== è¼•é‡ã€ä¸è¡çªçš„å…¨ç«™è¡Œç‚º ================== -->
  <script>
  (function () {
    "use strict";
    const PATH = location.pathname;
    const $ = (s, r=document)=>r.querySelector(s);

    /* A) æ–°å¢è¡¨å–®ï¼šç­åˆ¥è¨˜æ†¶ + è‘—è‰² */
    function paintShiftSelect(sel){
      if (!sel) return;
      sel.classList.add('shift-select');
      sel.classList.remove('is-morning','is-night');
      const v = (sel.value || sel.options?.[sel.selectedIndex]?.text || '').trim();
      if (/æ—©/.test(v)) sel.classList.add('is-morning'); else if (/æ™š/.test(v)) sel.classList.add('is-night');
    }
    function rememberShift(){
      const box = document.querySelector('.order-create'); if (!box) return;
      const sel = box.querySelector('select[name="shift"], .shift-select, [data-role="shift"]'); if (!sel) return;
      const KEY = 'orders_new_shift';
      const saved = sessionStorage.getItem(KEY);
      if (saved){
        for (const o of sel.options || []) {
          if (o.value === saved || (o.text||'').includes(saved)) { sel.value = o.value; break; }
        }
      }
      paintShiftSelect(sel);
      sel.addEventListener('change', ()=>{ paintShiftSelect(sel); sessionStorage.setItem(KEY, sel.value); });
    }

    /* B) è¨‚å–®å¿«é€Ÿæœå°‹ï¼ˆæ¸…ç©ºâ†’å›å…¨éƒ¨ï¼›æœå°‹å®Œè‡ªå‹•å›ç„¦ï¼‰ */
    function ordersQuickSearch(){
      if (!/^{{ rp|replace('/','\/') }}\/orders(\/|$)/.test(PATH)) return;  // è·Ÿ root_path ç›¸å®¹
      const toolbar = document.querySelector('.toolbar, .search-bar, .filter-bar'); if (!toolbar) return;
      const q = toolbar.querySelector('input[name="q"]'); if (!q) return;

      let prev = q.value || '';
      q.addEventListener('input', ()=>{
        const v = q.value || '';
        if (prev && !v && location.search) {
          sessionStorage.setItem('orders_focus_search','1');
          location.href = '{{ rp }}/orders#search';
        }
        prev = v;
      });

      const form = q.form;
      if (form){
        form.addEventListener('submit', ()=>{
          sessionStorage.setItem('orders_focus_search','1');
          try{
            const u = new URL(form.action || location.href, location.origin);
            form.action = u.pathname + u.search + '#search';
          }catch{}
        }, {capture:true});
      }

      function maybeFocus(){
        if (sessionStorage.getItem('orders_focus_search')==='1' || location.hash==='#search' || location.search){
          requestAnimationFrame(()=>{
            q.focus(); q.select?.(); toolbar.scrollIntoView({block:'start'});
          });
          sessionStorage.removeItem('orders_focus_search');
        }
      }
      document.addEventListener('DOMContentLoaded', maybeFocus);
      window.addEventListener('pageshow', maybeFocus);
    }

    /* C) KPI/æ”¯å‡º ç¯„åœè‡ªå‹•é€å‡º */
    function autoSubmitRangeForm(){
      const form = document.getElementById('range-form'); if (!form) return;
      const mode = form.querySelector('#mode') || form.querySelector('select[name="mode"]');
      const dt   = form.querySelector('#dt')   || form.querySelector('input[name="dt"]');
      if (mode) mode.addEventListener('change', ()=>form.submit());
      if (dt)   dt.addEventListener('change', ()=>form.submit());
    }

    /* D) æ–°å¢å®Œå›ç„¦å–®è™Ÿ */
    function focusOrderNoAfterCreate(){
      if (!/^{{ rp|replace('/','\/') }}\/orders(\/|$)/.test(PATH)) return;
      const input = document.getElementById('order_no_input') || document.querySelector('input[name="order_no"]');
      if (!input) return;
      if (location.hash==='#create' || sessionStorage.getItem('orders_focus_orderno')==='1'){
        requestAnimationFrame(()=>{ input.focus(); input.select?.(); });
        sessionStorage.removeItem('orders_focus_orderno');
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      rememberShift();
      ordersQuickSearch();
      autoSubmitRangeForm();
      focusOrderNoAfterCreate();
    });
  })();
  </script>

  <!-- ================== KPI é‡‘é¡è‡ªå‹•ç¸®æ”¾ï¼ˆåƒ… /kpi å•Ÿç”¨ï¼‰ ================== -->
  <script>
  (function(){
    if (!/^{{ rp|replace('/','\/') }}\/kpi(\/|$)/.test(location.pathname)) return;

    const MIN_PX = 22, STEP = 1, PAD = 6;
    function fit(el){
      if (!el) return;
      const base = parseFloat(getComputedStyle(el).fontSize) || 56;
      el.style.fontSize = base + 'px';
      let size = base, guard = 0;
      const overflows = () => (el.scrollWidth > el.clientWidth - PAD) || (el.scrollHeight > el.clientHeight - PAD);
      while (overflows() && size > MIN_PX && guard < 120){ size -= STEP; el.style.fontSize = size + 'px'; guard++; }
    }
    function fitAll(){ document.querySelectorAll('.kpi-card .kpi-value').forEach(fit); }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fitAll, {once:true}); else fitAll();
    window.addEventListener('resize', fitAll);
    if (document.fonts && document.fonts.ready) document.fonts.ready.then(fitAll);
    const root = document.querySelector('.kpi-wrap') || document.body;
    new MutationObserver(fitAll).observe(root, {subtree:true, childList:true, characterData:true});
    setTimeout(fitAll, 200); setTimeout(fitAll, 600);
  })();
  </script>

  <!-- ä¸» JSï¼ˆè·Ÿè‘— root_path èµ°ï¼‰ -->
  <script src="{{ url_for('static', path='/js/app.js') }}?v=dragfix1"></script>
</body>
</html>
