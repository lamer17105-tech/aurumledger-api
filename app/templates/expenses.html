{% extends "base.html" %}
{% block title %}æ”¯å‡º{% endblock %}
{% block content %}

{# ä¾æ¨¡å¼åˆ‡æ›æŒ‰éˆ•æ–‡å­—èˆ‡æ¨™ç±¤ #}
{% set prev_label   = 'å‰ä¸€å¤©' if mode=='day' else ('å‰ä¸€æœˆ' if mode=='month' else 'å‰ä¸€å¹´') %}
{% set today_label  = 'ä»Šæ—¥'   if mode=='day' else ('ä»Šæœˆ'   if mode=='month' else 'ä»Šå¹´') %}
{% set next_label   = 'å¾Œä¸€å¤©' if mode=='day' else ('å¾Œä¸€æœˆ' if mode=='month' else 'å¾Œä¸€å¹´') %}
{% set date_label   = 'æ—¥æœŸ'   if mode=='day' else ('æœˆä»½'   if mode=='month' else 'å¹´ä»½') %}

<style>
  /* äº”æ¬„å¹³å‡ç­‰å¯¬ + å…§å®¹éé•·çœç•¥ */
  .table--expenses{ table-layout:fixed; width:100%; }
  .table--expenses col{ width:20%; }
  .table--expenses th, .table--expenses td{
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  /* å…§åµŒç·¨è¼¯è¼¸å…¥æ¡†å¯¬åº¦èª¿æ•´ï¼Œé¿å…è¶…å‡ºæ ¼ç·š */
  .table--expenses .cell-editor{ width:100%; box-sizing:border-box; }
</style>

<div class="card toolbar toolbar--range">
  <form method="get" action="/expenses" class="row" style="gap:10px;flex-wrap:wrap;align-items:center">
    <label class="label">æ¨¡å¼</label>
    <select name="mode" id="exp-mode">
      <option value="day"   {% if mode=='day' %}selected{% endif %}>ç•¶æ—¥</option>
      <option value="month" {% if mode=='month' %}selected{% endif %}>ç•¶æœˆ</option>
      <option value="year"  {% if mode=='year' %}selected{% endif %}>ç•¶å¹´</option>
    </select>

    <label class="label">{{ date_label }}</label>
    <input type="date" name="dt" id="exp-dt" value="{{ dt }}">

    <a class="btn pill primary" href="/expenses?mode={{ mode }}&dt={{ nav.prev }}">â† {{ prev_label }}</a>
    <a class="btn pill primary" href="/expenses?mode={{ mode }}&dt={{ nav.today }}">{{ today_label }}</a>
    <a class="btn pill primary" href="/expenses?mode={{ mode }}&dt={{ nav.next }}">{{ next_label }} â†’</a>

    <label class="label">æœå°‹</label><input class="input" type="text" name="q" value="{{ q }}">
    <label class="label">èµ·</label><input class="input" type="date" name="start" value="{{ start }}">
    <label class="label">è¿„</label><input class="input" type="date" name="end" value="{{ end }}">
    <button class="btn pill" type="submit" style="white-space:nowrap">ğŸ”</button>
  </form>
</div>

<form class="card toolbar" method="post" action="/expenses/create" style="gap:10px;align-items:center">
  <label>{{ date_label }}</label><input class="input" type="date" name="odt" value="{{ dt }}">
  <label>åˆ†é¡</label>
  <!-- åˆ†é¡ä¸‹æ‹‰é¸å–®ï¼ˆå›ºå®šé¸é …ï¼‰ -->
  <select class="input" name="cat" required>
    <option>åŸæ–™</option>
    <option>ç§Ÿé‡‘</option>
    <option>äººäº‹</option>
    <option>èœéŒ¢</option>
    <option>é›œæ”¯</option>
    <option>ç§Ÿé‡‘æ°´é›»</option>
    <option>å…¶ä»–</option>
  </select>
  <label>é‡‘é¡</label><input class="input" type="number" name="amount" step="1" required>
  <label>å‚™è¨»</label><input class="input" type="text" name="memo" placeholder="å¯ç•™ç©º">
  <button class="btn primary" type="submit">æ–°å¢</button>
</form>

<form method="post" action="/expenses/delete" id="form-exp-delete">
  <table class="table table--expenses" id="expenses-table">
    <!-- äº”æ¬„å¹³å‡ 20% -->
    <colgroup>
      <col><col><col><col><col>
    </colgroup>
    <thead>
      <tr>
        <th class="center sortable" data-key="cat">
          <span class="th-label">åˆ†é¡</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="amount">
          <span class="th-label">é‡‘é¡</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="odt">
          <span class="th-label">{{ date_label }}</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center sortable" data-key="memo">
          <span class="th-label">å‚™è¨»</span>
          <span class="th-badge" title="å¯é»æ“Šæ’åºï¼å†é»ä¸€æ¬¡æ¢å¾©" aria-label="å¯é»æ“Šæ’åº">â‡…</span>
        </th>
        <th class="center">é¸å–</th>
      </tr>
    </thead>
    <tbody id="exp-body">
      {% for it in items %}
      <tr data-id="{{ it.id }}" data-idx="{{ loop.index0 }}">
        <td class="center editable" data-field="cat">{{ it.cat }}</td>
        <td class="center editable" data-field="amount">{{ it.amount | money }}</td>
        <td class="center editable" data-field="odt">{{ it.odt }}</td>
        <td class="center editable" data-field="memo">{{ it.memo }}</td>
        <td class="center"><input type="checkbox" name="selected" value="{{ it.id }}"></td>
      </tr>
      {% endfor %}
      {% if not items %}<tr><td colspan="5" class="center muted">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>{% endif %}
    </tbody>
  </table>

  <div class="actionbar left">
    <button class="btn pill danger" type="submit">åˆªé™¤é¸ä¸­</button>
  </div>
</form>

<script>
(function(){
  // è‡ªå‹•æäº¤æ¨¡å¼/æ—¥æœŸåˆ‡æ›
  const m=document.getElementById('exp-mode'); const d=document.getElementById('exp-dt');
  if(m) m.addEventListener('change',()=>m.form.submit());
  if(d) d.addEventListener('change',()=>d.form.submit());

  // ===== è¡¨å…§ç·¨è¼¯ =====
  const tbody = document.getElementById('exp-body');
  let editing = null;

  function makeEditor(td){
    const field = td.dataset.field;
    const tr = td.closest('tr');
    const id = tr.dataset.id;
    const oldTxt = td.innerText.trim();
    let input;

    if(field === 'odt'){
      input = document.createElement('input'); input.type='date'; input.value = oldTxt;
    }else if(field === 'amount'){
      input = document.createElement('input'); input.type='number'; input.step='1';
      input.value = oldTxt.replaceAll(',','');
    }else if(field === 'cat'){
      // åˆ†é¡ï¼šä¸‹æ‹‰é¸å–®ï¼ˆèˆ‡æ–°å¢ä¸€è‡´ï¼‰
      input = document.createElement('select');
      ["åŸæ–™","ç§Ÿé‡‘","äººäº‹","èœéŒ¢","é›œæ”¯","ç§Ÿé‡‘æ°´é›»","å…¶ä»–"].forEach(s=>{
        const o=document.createElement('option'); o.textContent=s; o.value=s;
        if(s===oldTxt) o.selected=true; input.appendChild(o);
      });
    }else{ // memo
      input = document.createElement('input'); input.type='text'; input.value = oldTxt;
    }
    input.className = 'cell-editor center';
    input.style.textAlign = 'center';

    td.dataset.old = oldTxt;
    td.innerHTML = ''; td.appendChild(input); input.focus(); if(input.select) input.select();

    const save = ()=>{
      const value = (input.value || '').trim();
      fetch('/expenses/update-json', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id, field, value})
      }).then(r=>r.json()).then(j=>{
        td.innerHTML = j.ok ? (field==='amount' ? Number(j.value).toLocaleString() : j.value) : td.dataset.old;
        editing = null;
      }).catch(()=>{ td.innerHTML = td.dataset.old; editing=null; });
    };
    const cancel = ()=>{ td.innerHTML = td.dataset.old; editing=null; };

    if (input.tagName === 'SELECT'){ input.addEventListener('change', save); }
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); save(); }
      if(e.key==='Escape'){ e.preventDefault(); cancel(); }
    });
    input.addEventListener('blur', ()=>{ if(editing) save(); });
    editing = {td, input};
  }

  tbody.addEventListener('click', (e)=>{
    const td = e.target.closest('td.editable');
    if(!td || editing) return;
    makeEditor(td);
  });

  // ===== è¡¨é ­æ’åºï¼ˆå†æ¬¡é»æ“Šæ¢å¾©åŸåºï¼‰ =====
  const table  = document.getElementById('expenses-table');
  const orig   = Array.from(tbody.querySelectorAll('tr'));
  let currentKey = null;

  function applySort(key){
    if(currentKey === key){
      tbody.innerHTML = '';
      orig.forEach(tr=>tbody.appendChild(tr));
      currentKey = null; return;
    }
    const rows = Array.from(orig);
    rows.sort((a,b)=>{
      const ta = a.querySelector(`[data-field="${key}"]`).innerText.trim().replace(/,/g,'');
      const tb = b.querySelector(`[data-field="${key}"]`).innerText.trim().replace(/,/g,'');
      if(key==='amount'){ return (Number(ta)-Number(tb)); }
      return (ta>tb?1:ta<tb?-1:0);
    });
    tbody.innerHTML = '';
    rows.forEach(tr=>tbody.appendChild(tr));
    currentKey = key;
  }
  table.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>applySort(th.dataset.key));
  });

  // ===== æ‹–æ›³å‹¾é¸ + Shift ç¯„åœå‹¾é¸ =====
  let dragging = false, dragState = true, lastClickIndex = null;

  tbody.addEventListener('mousedown', (e)=>{
    const cell = e.target.closest('td'); if(!cell) return;
    const cb = cell.querySelector('input[type="checkbox"]'); if(!cb) return;
    dragging = true; dragState = !cb.checked; cb.checked = dragState; e.preventDefault();
  });
  tbody.addEventListener('mouseover', (e)=>{
    if(!dragging) return;
    const tr = e.target.closest('tr'); if(!tr) return;
    const cb = tr.querySelector('input[type="checkbox"]'); if(cb) cb.checked = dragState;
  });
  document.addEventListener('mouseup', ()=> dragging = false);

  tbody.addEventListener('click', (e)=>{
    const cb = e.target.closest('input[type="checkbox"]'); if(!cb) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const idx  = rows.indexOf(cb.closest('tr'));
    if(e.shiftKey && lastClickIndex != null){
      const [s,eidx] = idx > lastClickIndex ? [lastClickIndex, idx] : [idx, lastClickIndex];
      for(let i=s;i<=eidx;i++){
        const cbi = rows[i].querySelector('input[type="checkbox"]');
        if(cbi) cbi.checked = cb.checked;
      }
    }
    lastClickIndex = idx;
  });
})();
</script>
{% endblock %}
