{% extends "base.html" %}
{% block title %}å ±è¡¨{% endblock %}
{% block content %}

{% set prev_label   = 'å‰ä¸€å¤©' if mode=='day' else ('å‰ä¸€æœˆ' if mode=='month' else 'å‰ä¸€å¹´') %}
{% set today_label  = 'ä»Šæ—¥'   if mode=='day' else ('ä»Šæœˆ'   if mode=='month' else 'ä»Šå¹´') %}
{% set next_label   = 'å¾Œä¸€å¤©' if mode=='day' else ('å¾Œä¸€æœˆ' if mode=='month' else 'å¾Œä¸€å¹´') %}
{% set date_label   = 'æ—¥æœŸ'   if mode=='day' else ('æœˆä»½'   if mode=='month' else 'å¹´ä»½') %}

<div class="card toolbar toolbar--range">
  <form id="rep-form" method="get" action="/reports" class="row">
    <label class="label">æ¨¡å¼</label>
    <select name="mode" id="rep-mode">
      <option value="day"   {% if mode=='day' %}selected{% endif %}>ç•¶æ—¥</option>
      <option value="month" {% if mode=='month' %}selected{% endif %}>ç•¶æœˆ</option>
      <option value="year"  {% if mode=='year' %}selected{% endif %}>ç•¶å¹´</option>
    </select>
    <label class="label">{{ date_label }}</label>
    <input type="date" name="dt" id="rep-dt" value="{{ dt }}">

    <a class="btn pill primary" href="/reports?mode={{ mode }}&dt={{ nav.prev }}">â† {{ prev_label }}</a>
    <a class="btn pill primary" href="/reports?mode={{ mode }}&dt={{ nav.today }}">{{ today_label }}</a>
    <a class="btn pill primary" href="/reports?mode={{ mode }}&dt={{ nav.next }}">{{ next_label }} â†’</a>
  </form>
</div>

<div class="export-strip minimalist">
  <button type="button" class="tile blue"  onclick="exportCsv('orders')">ğŸ§¾ å¦å­˜è¨‚å–® CSV</button>
  <button type="button" class="tile gold"  onclick="exportCsv('expenses')">ğŸ“„ å¦å­˜æ”¯å‡º CSV</button>
  <button type="button" class="tile green" onclick="exportCsv('sales')">âœ… å¦å­˜ç‡Ÿæ¥­é¡ CSV</button>
</div>

<script>
  // æ¨¡å¼/æ—¥æœŸè‡ªå‹•æäº¤
  const rf=document.getElementById('rep-form');
  document.getElementById('rep-mode').addEventListener('change',()=>rf.submit());
  document.getElementById('rep-dt').addEventListener('change',()=>rf.submit());

  // ä»¥åŸç”Ÿå¦å­˜ï¼ˆæ”¯æ´ Chrome/Edgeï¼›https æˆ– localhostï¼‰
  async function saveWithPicker(filename, blob){
    if ('showSaveFilePicker' in window){
      const handle = await window.showSaveFilePicker({
        suggestedName: filename,
        types: [{ description: 'CSV æª”æ¡ˆ', accept: { 'text/csv': ['.csv'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
    }else{
      // å¾Œå‚™ï¼šä¸‹è¼‰ï¼ˆåŒæ¨£å¯«å…¥å« BOM çš„ Blobï¼‰
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      alert('ç€è¦½å™¨ä¸æ”¯æ´åŸç”Ÿå¦å­˜ï¼Œå·²æ”¹ç‚ºä¸‹è¼‰ã€‚å»ºè­°ä½¿ç”¨ Chrome æˆ– Edgeã€‚');
    }
  }

  // å–å¾— CSVã€å¼·åˆ¶è£œ UTF-8 BOM ä½å…ƒçµ„å†å­˜æª”
  async function exportCsv(kind){
    const scope = document.getElementById('rep-mode').value;
    const dt    = document.getElementById('rep-dt').value;
    const url   = `/export/${kind}.csv?scope=${encodeURIComponent(scope)}&base=${encodeURIComponent(dt)}`;
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('åŒ¯å‡ºå¤±æ•—');

      // ä»¥ä½å…ƒçµ„å–å¾—ï¼Œç¢ºä¿æˆ‘å€‘èƒ½è‡ªå·±è™•ç† BOM
      let buf  = await res.arrayBuffer();
      let data = new Uint8Array(buf);

      // è‹¥å¾Œç«¯å·²å« BOMï¼Œå°±å…ˆå»æ‰ï¼Œé¿å…é‡è¤‡
      if (data.length >= 3 && data[0] === 0xEF && data[1] === 0xBB && data[2] === 0xBF){
        data = data.slice(3);
      }
      // å¼·åˆ¶åœ¨å‰é¢è£œä¸Š BOM
      const bom  = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const out  = new Uint8Array(bom.length + data.length);
      out.set(bom, 0);
      out.set(data, bom.length);

      const blob = new Blob([out], {type:'text/csv;charset=utf-8'});
      const filename = `${kind}_${scope}_${dt}.csv`;
      await saveWithPicker(filename, blob);
    }catch(err){
      console.error(err);
      alert('åŒ¯å‡ºéç¨‹ç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    }
  }
</script>
{% endblock %}
